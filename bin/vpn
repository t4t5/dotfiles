#!/usr/bin/env bash

# VPN helper script for NordVPN

default_country="Switzerland"

if [ $# -lt 1 ]; then
  echo "Usage: vpn <command>"
  echo ""
  echo "Commands:"
  echo "  on       Connect to VPN"
  echo "  off      Disconnect from VPN"
  echo "  toggle   Toggle VPN on/off"
  echo "  connect  Select country and connect"
  echo "  status   See status of connection"
  exit 1
fi

if [ "$1" = "on" ]; then
  nordvpn connect "$default_country"

elif [ "$1" = "off" ]; then
  nordvpn disconnect

elif [ "$1" = "toggle" ]; then
  if nordvpn status | grep -q "Status: Connected"; then
    nordvpn disconnect
  else
    nordvpn connect "$default_country"
  fi

elif [ "$1" = "status" ]; then
  nordvpn status

elif [ "$1" = "connect" ]; then
  countries=$(nordvpn countries | grep -v '^\*' | tr -s ' ' '\n' | grep -v '^$')

  if [ "$GUI" = "1" ]; then
    selected_country=$(echo "$countries" | menu -p "Connect:")
  else
    selected_country=$(echo "$countries" | fzf)
  fi

  if [ -z "$selected_country" ]; then
    echo "No country selected" >&2
    exit 1
  fi

  if [ "$GUI" = "1" ]; then
    nordvpn connect "$selected_country" | tail -1 | xargs -I{} notify-send "{}"
  else
    nordvpn connect "$selected_country"
  fi

else
  echo "Unknown command: $1"
  echo "Run 'vpn' without arguments for usage information"
  exit 1
fi
