#!/bin/bash

# Select a react-icon and copy its SVG to the clipboard.
# Requires: node, npm, rsvg-convert
# Setup: run "react-icons/build-previews" once to cache all icons.

DIR="$(cd "$(dirname "$0")" && pwd)"
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/react-icons"
NAMES_FILE="$CACHE_DIR/names.txt"
PKG_DIR="$CACHE_DIR/pkg"
QUERY_FILE="$CACHE_DIR/query.txt"
ELEPHANT_DIR="$HOME/.config/elephant/menus"

# Install react-icons npm package if not present
if [[ ! -d "$PKG_DIR/node_modules/react-icons" ]]; then
  mkdir -p "$PKG_DIR"
  (cd "$PKG_DIR" && npm install react-icons --silent 2>/dev/null)
fi

# Build names cache if missing
if [[ ! -f "$NAMES_FILE" ]]; then
  node "$DIR/build-cache.mjs" "$PKG_DIR" > "$NAMES_FILE"
fi

# Ensure elephant Lua menu is installed
if [[ ! -f "$ELEPHANT_DIR/react_icons.lua" ]]; then
  mkdir -p "$ELEPHANT_DIR"
  ln -sf "$DIR/react_icons.lua" "$ELEPHANT_DIR/react_icons.lua"
fi

query="$1"
if [[ -z "$query" ]]; then
  query=$(echo "" | walker --dmenu --inputonly -p "Icon name (Hit enter to search)")
  [[ -z "$query" ]] && exit 0
fi

# Write query for the Lua script to read
printf '%s' "$query" > "$QUERY_FILE"

# Ensure elephant is running (needed for menus module)
if ! pgrep -x elephant > /dev/null; then
  elephant &>/dev/null &
  while ! pgrep -x elephant > /dev/null; do sleep 0.1; done
fi

# Suppress noisy output:
walker -m menus:reacticons
