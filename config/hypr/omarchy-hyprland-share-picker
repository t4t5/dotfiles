#!/bin/bash

# Debug logging
LOGFILE="/tmp/hyprland-share-picker.log"
exec 2>>"$LOGFILE"
echo "=== Picker started at $(date) ===" >> "$LOGFILE"
echo "Arguments: $@" >> "$LOGFILE"

ALLOW_TOKEN=true  # Always allow restore token to prevent re-prompting
# [[ "$1" == "--allow-token" ]] && ALLOW_TOKEN=true
echo "ALLOW_TOKEN=$ALLOW_TOKEN" >> "$LOGFILE"

output_selection() {
  local type="$1"
  local value="$2"

  echo "output_selection called: type=$type value=$value" >> "$LOGFILE"
  echo -n "[SELECTION]"
  [[ "$ALLOW_TOKEN" == "true" ]] && echo -n "r"
  echo "/${type}:${value}"
  echo "Output sent to stdout" >> "$LOGFILE"
  exit 0
}

show_screen_tab() {
  local options=()
  local connectors=()

  echo "show_screen_tab called" >> "$LOGFILE"

  while IFS='|' read -r connector desc width height; do
    local friendly_name=$(sed -E 's/ (0x[0-9A-F]+|[A-Z0-9]{10,})$//' <<<"$desc")
    options+=("$friendly_name (${width}x${height}) - $connector")
    connectors+=("$connector")
    echo "Added option: $friendly_name (${width}x${height}) - $connector" >> "$LOGFILE"
  done < <(hyprctl monitors -j 2>/dev/null | jq -r '.[] | "\(.name)|\(.description)|\(.width)|\(.height)"' 2>/dev/null)

  echo "Showing walker menu..." >> "$LOGFILE"
  local selected=$(printf '%s\n' "${options[@]}" | walker --dmenu -p "Share Screen…" 2>>"$LOGFILE")
  echo "Walker returned: '$selected'" >> "$LOGFILE"

  for i in "${!options[@]}"; do
    echo "Checking if '${options[$i]}' == '$selected'" >> "$LOGFILE"
    [[ "${options[$i]}" == "$selected" ]] && output_selection "screen" "${connectors[$i]}"
  done

  echo "No match found, exiting with code 1" >> "$LOGFILE"
  exit 1
}

show_window_tab() {
  [[ -z "$XDPH_WINDOW_SHARING_LIST" ]] && exit 1

  local options=()
  local ids=()
  local rolling="$XDPH_WINDOW_SHARING_LIST"

  while [[ -n "$rolling" && "$rolling" == *"[HC>]"* ]]; do
    local id="${rolling%%\[HC>\]*}"
    rolling="${rolling#*\[HC>\]}"

    local class="${rolling%%\[HT>\]*}"
    rolling="${rolling#*\[HT>\]}"

    local title="${rolling%%\[HE>\]*}"
    rolling="${rolling#*\[HE>\]}"

    rolling="${rolling#*\[HA>\]}"

    if [[ -n "$id" && -n "$title" ]]; then
      options+=("$title")
      ids+=("$id")
    fi
  done

  local selected=$(printf '%s\n' "${options[@]}" | walker --dmenu -w 350 -p "Share Window…" 2>/dev/null)

  for i in "${!options[@]}"; do
    [[ "${options[$i]}" == "$selected" ]] && output_selection "window" "${ids[$i]}"
  done

  exit 1
}

show_region_tab() {
  local geometry=$(slurp -f "%o %x %y %w %h" 2>/dev/null)

  if [[ -n "$geometry" ]]; then
    read -r output x y w h <<<"$geometry"
    output_selection "region" "${output}@${x},${y},${w},${h}"
  fi

  exit 1
}

main_menu() {
  echo "main_menu called" >> "$LOGFILE"
  local choice=$(printf "Screen\nWindow\nRegion" | walker --dmenu --theme omarchy-default -p "Share…" 2>>"$LOGFILE")
  echo "Main menu choice: '$choice'" >> "$LOGFILE"

  case "$choice" in
  Screen) show_screen_tab ;;
  Window) show_window_tab ;;
  Region) show_region_tab ;;
  *) echo "No valid choice, exiting" >> "$LOGFILE"; exit 1 ;;
  esac
}

main_menu
