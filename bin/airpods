#!/bin/bash

# AirPods MAC address
AIRPODS_MAC="9C:F3:AC:4F:02:AA"
AIRPODS_MAX_MAC="90:9C:4A:DD:05:DE"

# Default to regular AirPods
MAC="$AIRPODS_MAC"

case "$1" in
    connect)
        if [ "$2" = "max" ]; then
            MAC="$AIRPODS_MAX_MAC"
            echo "Connecting to AirPods Max..."
        else
            echo "Connecting to AirPods..."
        fi
        CONNECT_OUTPUT=$(bluetoothctl connect "$MAC" 2>&1)
        if [ $? -ne 0 ]; then
            echo "Failed to connect:"
            echo "$CONNECT_OUTPUT"
            exit 1
        fi
        # Wait for the bluez sink to appear in PipeWire
        SINK="bluez_output.${MAC//:/_}"
        for i in $(seq 1 10); do
            pactl list sinks short 2>/dev/null | grep -q "$SINK" && break
            sleep 1
        done
        pactl set-default-sink "$SINK" &>/dev/null
        pactl set-default-source "bluez_input.${MAC//:/_}" &>/dev/null
        echo "Connected successfully!"
        ;;
    disconnect)
        if [ "$2" = "max" ]; then
            MAC="$AIRPODS_MAX_MAC"
            echo "Disconnecting AirPods Max..."
        else
            echo "Disconnecting AirPods..."
        fi
        if bluetoothctl disconnect "$MAC" &>/dev/null; then
            echo "Disconnected successfully!"
        else
            echo "Failed to disconnect."
            exit 1
        fi
        ;;
    toggle)
        is_connected() {
            bluetoothctl info "$1" 2>/dev/null | grep -q "Connected: yes"
        }
        if is_connected "$AIRPODS_MAC"; then
            airpods disconnect
        elif is_connected "$AIRPODS_MAX_MAC"; then
            airpods disconnect max
        else
            choice=$(printf 'AirPods\nAirPods Max\n' | menu -p "Connect:")
            case "$choice" in
                "AirPods") airpods connect ;;
                "AirPods Max") airpods connect max ;;
                *) exit 1 ;;
            esac
        fi
        ;;
    *)
        echo "Usage: airpods {connect|disconnect|toggle} [max]"
        echo "Examples:"
        echo "  airpods connect      - Connect to AirPods"
        echo "  airpods connect max  - Connect to AirPods Max"
        echo "  airpods disconnect   - Disconnect AirPods"
        echo "  airpods toggle       - Toggle connection"
        exit 1
        ;;
esac
